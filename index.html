<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-tw">

<head runat="server">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>唐鳳都在這</title>
    <link rel="shortcut icon" href="stylesheets/images/favicon.ico" type="image/x-icon">
  
    <script src="https://cdn.jsdelivr.net/npm/vue" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.4/moment.min.js" crossorigin="anonymous"></script>

    <!--bootstrap-->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="stylesheets/style.css">

</head>

<body>
    <div role="main">
        <div class="container" style="padding:10px;">
            <div class="row" style="padding-top:20px;">
                <div class="col-12" style="text-align:center;">

                    <div class="row" style="padding-top:30px;">
                        <div class="col-12" style="text-align:center;">
                            <a title="顯示地圖" target="_blank" href="https://www.google.com/maps/place/%E7%A4%BE%E6%9C%83%E5%89%B5%E6%96%B0%E5%AF%A6%E9%A9%97%E4%B8%AD%E5%BF%83/@25.0389127,121.5411135,18z/data=!4m15!1m9!2m8!1z6aOv5bqX!3m6!1z6aOv5bqX!2s25.039406399999997,+121.53986929999999!3s0x3442abd6f627f72d:0x16aa317708e699c5!4m2!1d121.5398693!2d25.0394064!3m4!1s0x3442a983817f600d:0xa055f2f16c67c77d!8m2!3d25.0386229!4d121.5409823?hl=zh-TW">
                                <div class="hbanner">
                                    每周三 唐鳳都在社創中心 </div>
                            </a>
                            <div class="headerlogo">
                                <div class="htitle">
                                    為了方便拜會作業進行，唐鳳office hour調整如下：
                                </div>
                                <div class="hcontent">
                                    10:00-14:00 自由前來，無需預約
                                    <br> 14:00-17:00 預約保留時段
                                    <a target="_blank" style="padding-left: 10px;" href="https://au.pdis.tw">
                                        <i class="fa fa-calendar"></i>我要預約</a>
                                    <!-- <br>如拜會有任何問題，請來信至 <a href="mailto:hello@pdis.tw">hello@pdis.tw</a> -->
                                </div>
                                <div class="hcontent">因行程多有變動，<b>本辦保留調整此行事曆的權利，實際情況以<font color="red">現場情況</font>為準</b>，敬請見諒。
                                    <br>如有疑問請來信：<a href="mailto:hello@pdis.tw">hello@pdis.tw</a></div>
                            </div>
                        </div>
                        <hr />

                        <div id="calenderList" class="row">
                            <div id="calender" v-for="calender in calenders" class="col-sm-6 col-lg-3 col-12 left" style="padding: 0px;">
                                <div :class="calender.cls">
                                    <div class="calenderContent">
                                        <div class="calenderTitle">{{calender.title}}</div>
                                        <!-- <div class="calenderDate">{{calender.date}}</div> -->
                                        <div :class="calender.clsSubtitle">
                                            <span style='color:black;'>現場拜會：</span>{{calender.subtitle}}</div>
                                        <div :class='"calenderBookStatus"+" "+ calender.clsBookStatus'>
                                            <span style='color:black;'>提前預約：</span>{{calender.bookStatus}}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />
                    </div>

                    <div class="col-12">
                        <div id="updateDT" style="float:right;"> 最後更新時間：{{ updateDT }} GMT+8
                            <br>※此行事曆每三小時更新，實際情形以現場為準
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

        <script>
            function findOfficeHourByDate(date, elements) {
                let nDate = moment.utc(date).local().format("YYYY-MM-DD");
                let item = undefined;
                elements.forEach(element => {
                    if(nDate==moment.utc(element.start).local().format("YYYY-MM-DD")) {
                        item = element;
                    }
                });
                return item;
            }
            var calender = new Vue({
                el: '#calenderList',
                data: {
                    calenders: []
                }
                ,
                created: function initCalender() {
                    var calenders = [];
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', 'https://aucal.pdis.nat.gov.tw/auCal');
                    xhr.send();
                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            var res = JSON.parse(xhr.responseText);
                            var dayList = getWednesday(4, new Date().getDate());
                            var pointer = 0;

                            var resBook;
                            var xhrBook = new XMLHttpRequest();
                            xhrBook.open('GET', 'https://aucal.pdis.nat.gov.tw/getReserve');
                            xhrBook.send();
                            xhrBook.onload = function () {
                                if (xhrBook.status === 200) {
                                    resBook = JSON.parse(xhrBook.responseText);
                                    var booked = {};

                                    resBook.reservations.forEach(function(element) {
                                        var tmpKey = element.startDate.substring(0, element.startDate.indexOf('T'));

                                        //後臺預約起訖跨多個時段時 前臺顯示並計算出跨幾個已預約時段
                                        let times = moment.utc(element.bufferedEndDate).local().valueOf()/1000-moment.utc(element.bufferedStartDate).local().valueOf()/1000;
                                        var numOfSlot = Math.ceil(times/(60*60)); // 60min per slot

                                        if (typeof booked[tmpKey] === 'undefined') {
                                            booked[tmpKey] = numOfSlot;
                                        }
                                        else {
                                            booked[tmpKey] = booked[tmpKey] + numOfSlot;
                                        }
                                    });

                                    const availableTimespans = ["T14:00", "T15:00", "T16:00"];
                                    var MaxBooking = availableTimespans.length; //每日可預約總數
                                    const MaxAvailableMonth = 3; //開放可預約月數 本月+N月
                                    calenders.forEach(function(element) {
                                        if (booked[element.fullDT] == MaxBooking) {
                                            element.bookStatus = "已額滿"
                                            element.clsBookStatus="red"
                                        }
                                        else if (booked[element.fullDT] < MaxBooking) {
                                            element.bookStatus = "尚可預約"
                                            element.clsBookStatus="blue"
                                        }
                                        else if (new Date(element.fullDT).getMonth() <= (new Date().getMonth() + MaxAvailableMonth) && new Date(element.fullDT) > new Date()) {

                                            element.bookStatus = "尚可預約"
                                            element.clsBookStatus="blue"
                                        }
                                        else {
                                            element.bookStatus = "未開放預約"
                                            element.clsBookStatus="red"
                                        }

                                    });

                                }
                                else {
                                    //err
                                }
                            };

                            dayList.forEach(function (element) {

                                if (calenders.length >= 12) {
                                    return;
                                }
                                let day = element;
                                let item = findOfficeHourByDate(day, res.items);
                                var date = ("0" + (element.getMonth() + 1)).slice(-2) + "-" + ("0" + element.getDate()).slice(-2); //MM/dd

                                if(item==undefined) {
                                    var objCalender = { fullDT: element.getFullYear() + "-" + date, title: date + "(三)", date: date + "(三)", subtitle: "另有公務行程", cls: "calenderRed", clsSubtitle: "calenderSubtitle red", bookStatus: "", clsBookStatus: "" }
                                    calenders.push(objCalender);
                                }else {
                                    var startHHmm = moment.utc(item.start).local().format("HH:mm");
                                    var clsSubtitle = 'calenderSubtitle blue';
                                    if (startHHmm != "10:00") {
                                        clsSubtitle = 'calenderSubtitle red';
                                    }
                                    var datetime = startHHmm + "～" + moment.utc(item.end).local().format("HH:mm");
                                    var objCalender = { fullDT: element.getFullYear() + "-" + date, title: date + "(三)", date: date + "(三)", subtitle: datetime, cls: "calenderGreen", clsSubtitle: clsSubtitle, bookStatus: "" , clsBookStatus: ""}
                                    calenders.push(objCalender);
                                }
                           
                                // var date = ("0" + (element.getMonth() + 1)).slice(-2) + "-" + ("0" + element.getDate()).slice(-2); //MM/dd
                      
                                // // if(!res.items[pointer]) {return;}
                                // var auDate = moment.utc(res.items[pointer].start).local().format("MM-DD");
                                // console.log(date + "  " + auDate);
                                // if (auDate === (date)) {
                                //     //勞動節要上工
                                //     if (res.items[pointer].holiday == true && moment.utc(res.items[pointer].start).local().format("MM-DD") != "05-01") {//排除假日
                                //         console.log(date + "holiday")
                                //     }
                                //     else {
                                //         var startHHmm = moment.utc(res.items[pointer].start).local().format("HH:mm");
                                //         var clsSubtitle = 'calenderSubtitle blue';
                                //         // if (startHHmm != "10:00") {
                                //         //     clsSubtitle = 'calenderSubtitle red';
                                //         // }
                                //         var datetime = startHHmm + "～" + moment.utc(res.items[pointer].end).local().format("HH:mm");
                                //         var objCalender = { fullDT: element.getFullYear() + "-" + date, title: date + "(三)", date: date + "(三)", subtitle: datetime, cls: "calenderGreen", clsSubtitle: clsSubtitle, bookStatus: "" , clsBookStatus: ""}
                                //         // only for now ~ 5/20
                                //         // var objCalender = { fullDT: element.getFullYear() + "-" + date, title: date + "(三)", date: date + "(三)", subtitle: "另有公務行程", cls: "calenderRed", clsSubtitle: "calenderSubtitle red", bookStatus: "", clsBookStatus: "" }

                                //         calenders.push(objCalender);
                                //     }
                                //     pointer++;
                                // }
                                // else {
                       
                                // }
                            });

                            new Vue({
                                el: '#updateDT',
                                data: {
                                    updateDT: moment.utc(res.updateTime).local().format("YYYY-MM-DD HH") + ":00"
                                }
                            })

                        }
                        else {
                            //err
                        }
                    };

                    this.calenders = calenders;

                    var interval_time = 1000 * 60 * 60 * 1; //getCalendar every 3 hrs here every 1 hrs
                    setInterval(function () {
                        initCalender();
                        console.log("re render");

                    }, interval_time);
                }
            })

            function getWednesday(monthCount, setfirstDate) {
                var d = new Date(),
                    month = d.getMonth(),
                    Wednesdays = [];

                d.setDate(setfirstDate);
                // Get the first Wednesday in the month
                while (d.getDay() !== 3) {
                    d.setDate(d.getDate() + 1);
                }
                var tmpd = new Date();
                tmpd.setMonth(tmpd.getMonth() + monthCount);
                var endmonth = tmpd.getMonth();

                // Get all the other Wednesday in the month
                while (d.getMonth() !== endmonth) {
                    Wednesdays.push(new Date(d.getTime()));
                    d.setDate(d.getDate() + 7);
                }
                return Wednesdays;
            }

        </script>

</body>

</html>
